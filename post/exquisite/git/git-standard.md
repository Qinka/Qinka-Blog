# Git 使用规范

## Commit 规范

Git 的 commit 是代码变更的重要单元。 Git 通过记录每一次代码的变更跟踪代码。
这一节内容是有关于 Git 的 commit 的规范

### Commit 消息规范

每一次提交（Commit）应该包含对于变更内容的说明。
说明格式应该包括一行的总结与多行的详细说明。

```
[TYPES] [SUMMARY]
[EMPTY LINE]
[DETAILS]
```

`[TYPES]` 应该包含本次提交的内容的目的。一般来说有如下目的：

* 针对项目中一个需求、用户故事、用户卡片、文档中规定的功能 的代码变更。
`[TYPES]` 中可以有 "DEMAND-xxx"、"STORY-xxx"、"CARD-xxx"、"FEATURE-xxx"，
其中 “xxx” 是对应的项目的编号。这个编号应该与敏捷开发管理软件或者文档中的相关内容一致。
* 对于更新代码的目的，例如修复 BUG、更新配置文件、添加代码等
`[TYPES]` 中应该有诸如 "update"、"add"、"delete"、"fix"、"fixed"等。

`[SUMMARY]` 则应该包含对变更内容的简单的说明，内容主要由名词组成。

`[DETAILS]` 中应该注明修改了那些文件，与修改的具体目的或者意义。逐条详细列出代码变更相关的内容。

`[EMPTY LINE]` 则是一行空行，一般用于分割详细内容与简要内容。

下面是一个简单的实例，
```
update card-10238992 完成 UART4 代码

1. UART4 的配置已经修改为宏定义，可随时调整配置。修改 src/hardware/uart4.c 与 include/hardware/uart4.h
2. 利用 UART4 口进行调试的代码已经完成。 src/debug.c 已经修改。
```

Git 的提交信息还会被相关集成工具的使。例如 GitHub 中在提交的摘要中如果有
`#23 fixed` 之类的字眼，会自动关闭 GitHub 仓库 "issues" 中的 23 号问题。
例如 Travis-CI 中，如果 commit 信息有 `[ci skip]`， Travis-CI 则会跳过对这一提交的集成。

Commit 信息也是大小版本迭代式 “Changelog”的内容。

### Commit 内容规范

Git 提交的内容规范从提交内容变更大小，提交时间，修改的内容出发。
提交的内容经可能详细，但是不应该过细。对于一个基本的功能的相关代码可以提交一次，每次提交应该及时推送到主服务器中。

Git 每一次提交的内容不应该跨越一天，每一天修改的代码应该及时提交。如果发生当天代码无法全部完成时，应该试图分割提交内容。或者再提交信息中填写 "checkpoint" 这样的内容，然后再第二天的提交中使用 `--amend` 追加内容。

修改的内容要和分支对应。不应该再当前的提交中提交与当前分支不想关的内容。对于所有分支均会涉及到的内容，需要在这些分支的“基础分支”修改之后然后合并到各个分支。

### Commit 提交人规范

每一个提交的“署名”人需要留有自己的名字与邮箱。提交必须使用 GnuPG 进行有效的签名。

## .gitignore 文件规范

.gitignore 文件中存放的“忽略规则” 应该包括如下内容:

* 编译过程种产生的中间文件与目标代码
* IDE 或 编译器配置文件
* 项目工程文件（不包括 CMake、 Unix Makefile、auto-xx 等基础编译构建脚本）
* 打包生成内容

## 分支使用规范

编码过程中应该灵活使用 git 的 branch 功能。代码开发中应该有四类分支（branch）或同时存在于项目代码的仓库中。

* 稳定分支
* 主开发分支
* 旁路开发分支
* 修复分支

**稳定分支** 应当存放当前处于支持阶段且功能稳定的分支。分支本身的内容是应该经过测试达到“正式”发布的内容。（对于支持期过期的分支代码应该签入标签（tag）经行保存。 对于代码稳定分支前，或者稳定分支合并修复并且变更版本号时均需要签入新的标签。）

**主开发分支** 主要有两种用途：
* 每个大版本开发时，直接在主开发分支中完成最主要功能
* 从主开发分支迁出“旁路开发分支”与“修复分支”，然后进行开发或者修复，然后在合适的时机迁回主开发分支。

**旁路开发分支** 对于两个以上可以并行的开发内容（且不是最基础的主要功能），则可以迁出多个分支进行并行发开。内容在测试之后可以合并回开发主分支。

**修复分支** 修复分支主要是修复已有内容的 BUG，在与 Git 集成的软件中标注的 BUG 都应该迁出分支经行修复。修复的内容在测试之后可以合并回开发主分支或者稳定分支。

### 分支命名于内容规范

分支命名针对上述四种分支分别为：

* 稳定分支一般是 master 分支或者 stable/xxx 其中 xxx 是分支的名字，一般是版本号
* 主开发分支一般是 dev/master 或者 dev/xxx/master （其中 xxx 是一个大项目的<del>独立</del>子模块）
* 旁路开发分支一般是 dev/xxx，其中 xxx 分支名称，但不与主开发分支重名。xxx 模块的名字一般与文档或者开发控制软件中的相关。

### 合并规范

每次合并应该确保合并是必要的或者计划的。如果 Git 无法自动合并，则需要在合并的提交信息中写明合并内容、冲突内容与合并目的。

如果修改的内容是针对许多分支的“基础分支”，那么就需要 rebase 操作而不是合并操作。

### “人数”限制

对于一般不熟悉 Git 的开发团队来说，一般要求一个人负责负责一个模块，每个分支只有一个人进行编码，其他人无论应为何种原因，都不应该直接修改他人负责的分支，而是从目标分支中迁出，并提交 **Pull Requests**。

## Git 钩子规范与自动化工具

【TODO】

## Git 仓库内容规范

仓库中应该存在的三类文件：
* 代码及 Makefile 编辑脚本
* 文档（包括 ReadMe、 License等文件）
* Git 仓库相关文件与自动化工具配置文件

## Git 子模块规范

对于仓库依赖的内容，需要其代码的时候，必须使用 git 的子模块。子模块的版本应该保持稳定版本。

## Git Tag 规范 与 版本迭代规范

## Git rebase 规范